https://www.ruanyifeng.com/blog/2017/05/websocket.html

## 1. 什么是 WebSocket

WebSocket 是一种网络通信协议，和 HTTP 协议一样，都是基于 TCP 协议的。但是 WebSocket 是全双工通信的，而 HTTP 是半双工通信的。

WebSocket 协议在 2011 年由 IETF 标准化为 RFC 6455 ，后由 W3C 定为国际标准。

WebSocket 使得客户端和服务器之间的数据交换变得更加简单，允许服务端主动向客户端推送数据。

在 WebSocket API 中，浏览器和服务器只需要完成一次握手，两者之间就直接可以创建持久性的连接，并进行双向数据传输。

## 2. WebSocket 与 HTTP 协议

WebSocket 协议和 HTTP 协议一样，都是基于 TCP 协议的。但是 WebSocket 协议是全双工通信的，而 HTTP 协议是半双工通信的。

在没有 WebSocket 之前，浏览器和服务器之间的通信都是通过 HTTP 协议进行的，聊天室这种频繁的请求-响应模式，只能采用轮询的方式进行。

短轮询（Short Polling）：
- 实现方式：客户端定期发送 HTTP 请求到服务器，询问是否有新数据。
- 特点：每次请求都是独立的，服务器立即返回响应，无论是否有新数据。
- 缺点：可能会导致大量无效请求，因为每次请求都需要建立和关闭连接，增加了网络和服务器的负担。

之后出现了长轮询技术，它通过服务器端等待请求，直到有数据可发送，然后立即发送，再断开连接，从而实现了一种类似 WebSocket 的通信模式。
- 实现方式：客户端发送请求后，服务器保持连接打开，直到有新数据可用或超时才返回响应。
- 特点：如果有新数据，服务器立即返回响应；如果没有新数据，服务器会保持连接一段时间，直到有数据或超时。
- 优点：减少了无效请求的次数，因为服务器只在有新数据时才返回响应。
- 缺点：虽然比短轮询更高效，但仍然需要频繁建立和关闭连接。
- 长轮询一般超时时间为 几秒到几十秒甚至几分钟不等，主要是看业务需求。

而 WebSocket 协议则是在一次握手后，就可以进行双向数据传输，直到连接断开。
- 在浏览器环境中，websocket 提供一系列的 callback 函数，用于处理连接、数据接收、错误等事件。
    - onopen：连接建立时触发
    - onmessage：接收到服务器发送的数据时触发
    - onerror：发生错误时触发
    - onclose：连接关闭时触发
- 同时，websocket 还提供了 send 方法，用于向服务器发送数据。
- bufferedAmount：缓冲区中的字节数，用于指示发送缓冲区中未发送的数据量。
- readyState：表示 WebSocket 的连接状态，有四种状态：
    - CONNECTING：连接正在建立中
    - OPEN：连接已建立，可以进行通信
    - CLOSING：连接正在关闭中
    - CLOSED：连接已关闭
- 在 Node.js 环境中，则提供了 WebSocket 类，用于创建和管理 WebSocket 连接。

## 3. 为什么 websocket 有 onerror, onclose 事件，我们一般还需要采用心跳包来检测连接状态？
- 因为 websocket 的 onerror, onclose 事件在浏览器中并不总是可靠，可能会出现误报。
- 而心跳包则是一种简单有效的方式，用于检测连接状态。
1. 检测连接状态：
onclose 和 onerror 事件只能在连接已经断开或发生错误时触发，而心跳机制可以主动检测连接的健康状态，及时发现潜在的问题
2. 网络波动：
在某些网络环境下，连接可能会因为网络波动而中断，但不会立即触发 onclose 或 onerror。心跳机制可以帮助检测这种情况，并在必要时重新建立连接。
3. 防止中间设备超时：
在某些网络环境下，中间设备（如防火墙、路由器等）可能会因为长时间没有收到数据而关闭连接。心跳机制可以帮助检测这种情况，并在必要时重新建立连接。
4. 保持连接活跃：
心跳机制可以确保连接在长时间不活动的情况下仍然保持活跃，避免因为长时间没有数据传输而导致连接被误认为已断开。
5. 应用层的需求：
在某些应用场景中，需要确保连接的稳定性和可靠性，心跳机制可以帮助实现这一点。
6. 网络分区：
网络分区（Network Partition）可能导致客户端和服务器之间的连接中断，但由于分区的性质，双方都没有意识到连接已经断开。心跳机制可以检测到这种情况，因为 ping 消息无法到达对方。

- 心跳包的实现方式：
    - 客户端定期发送 ping 消息到服务器，服务器收到后立即返回 pong 消息。
    - 如果客户端在一定时间内没有收到 pong 消息，则认为连接已断开，并重新建立连接。
    - 如果服务器在一定时间内没有收到 ping 消息，则认为连接已断开，并重新建立连接。

## 4. 项目中的 WebSocket 实现与重连机制

WebSocket 重连时机：
1、手机设备网络发生变化时，如 wifi 切换 4g，切换成功后重新建立连接
2、从无网络连接到连上网，重新建立连接
3、ping 失败，但是当前仍可以正常连网（小程序需要在前台），重新建立连接
4、userSig 过期，为避免重新登录再次被踢，重新建立连接
5、收到 REST API kick 通知时断开连接并强制重连

其中主要 NetMonitor 检测网络变化，
在 web 浏览器中的话主要就是采用 addEventListner 的 online 和 offline 事件来检测网络变化
在小程序中则是采用 wx.onNetworkStatusChange 来检测网络变化
在 RN 中则是采用 NetInfo 来检测网络变化

重连逻辑：
主域名和备用域名轮流重连，重连三次后，如果仍然失败，会在网络监听模块 netMonitor 中进行网络状态检测，如果检测到确实是断网了，则断开链接。如果检测到非断网，则继续重连。


